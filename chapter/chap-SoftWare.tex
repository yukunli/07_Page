\chapter{水分测量系统软件设计}\label{chap5}

软件设计是本课题非常重要的一部分工作，本章将对水分测量系统的软件部分进行设计和说明，包括两大部分：下位机软件设计和上位机软件设计。下位机软件设计除了阐述数据采集程序、控制器与工业串口屏通信程序以及温控程序外，重点实现了数字锁相放大器的~C~语言算法实现。从~A/D~采集回来的正弦模拟量经过数字锁相放大器后能够得到高信噪比的信号幅值，从而参与烧结料水分含量的计算。上位机主要是组态工业串口屏软件的设计，串口屏能够直观、实时地显示当前物料的水分含量，是水分测量系统必不可少的人机交互窗口。

\section{水分测量系统整体软件结构}

水分测量系统的软件设计包括下位机~DSP~驱动程序的设计、数字锁相放大器算法设计以及组态工业串口屏设计。其中，DSP~驱动程序主要实现模拟数据的采集、数据的实时通讯、温度的检测和控制以及指示报警等功能。整体的软件框架如图\ref{}。
\section{下位机软件设计}

\subsection{数据采集程序的设计}
本课题有三路正弦信号进入~A/D~转换通道进行同步模数转换，所以对于~AD7656~而言，其采样频率的选取应综合三路正弦信号频率满足奈奎斯特采样定律以及~AD~芯片最大转换速率进行考虑。基于第~3~章节对数字锁相放大器的仿真和分析，本文选用~120KHz~作为采样频率对这三路信号进行采样和转换，每路信号连续采集~420~个点序列。
\begin{figure*}[!h]
\centering
\includegraphics[width=13cm]{fig73.png}
\caption {AD7656~并行接口模式工作时序图}
\addtocounter{figure}{-1}
\renewcommand\figurename{Fig.}
\caption{\label{fig73} Work sequence diagram of AD7656~ parallel interface mode}
\end{figure*}

本文采用~AD7656~并行工作模式，图\ref{fig73}所示是~AD7656~在并行方式下的工作时序图。首先通过脉冲激活~CONVST~输入来启动模数转换，并保持为高电平。当转换过程结束后，BUSY~信号会出现下降沿，此时，可通过控制片选和读信号引脚来依次读出各个通道的~AD~转换值。在读出转换值后，可改变~CONVST~为低电平，为下一次转换做准备。本课题通过控制~CONVST A~和~CONVST B~信号转换前4路通道的模拟信号，前3路信号为待测信号，第四路信号为模拟地。

本文设计的数据采集程序主要包括~TMS320F28335~的~IO~口初始化、AD7656~控制时序的产生及状态查询、采集数据的处理。其程序的流程图如图~\ref{fig74}~所示.
\begin{figure*}[!h]
\centering
\includegraphics[width=11cm]{fig74.pdf}
\caption {数据采集程序流程图}
\addtocounter{figure}{-1}
\renewcommand\figurename{Fig.}
\caption{\label{fig74} Data acquisition program flow chart}
\end{figure*}

\subsection{数据通讯程序的设计}
下位机的通讯程序主要功能是将~DSP~处理后的数据发送到组态工业串口屏进行显示，本文设计的通讯采用~TMS320F28335~的串行通信接口（~SCI~），与~UART~类似。SCI~接收器和发送器各自拥有一个~16~级深度的~FIFO，也各自拥有自己的使能和中断位，两者都能独立进行半双工通信，或者联立建立全双工通信。为了保证数据的完整性，SCI~模块会对接收到的数据进行简断检测、奇偶性、溢出和帧错误等检测。通过一个~16~ 位波特率寄存器的编程，可配置不同的通信速率。

本课题采用的组态工业串口屏是集~TFT~显示驱动、图片字库存储、GUI~操作、RTC~显示及各种组态控件于一体的串口显示终端。本章第~\ref{end_TFT}~节将对该触摸屏做详细的介绍。

工业串口屏通过指令帧的方式与微控制进行数据通信。当触摸屏有画面切换或动作更新时，会通过一定格式的指令帧将信息发送回下位机，下位机接收到帧信息并对帧信息解释后执行相应的处理，并通过指令帧的形式将动作信息或数据信息发送给触摸屏。一条完整的串口指令帧格式如表~\ref{table51}~所示。如果指令参数大于~1~个字节，则高字节在前、低字节在后。指令的最大长度为~1024~字节（包含帧头和帧尾），数值均为十六进制。串口格式：8~位数据位、1~位停止位、无效验位。
\begin{table*}[!h]\tiny
\caption{无~CRC~校验指令帧格式}
\addtocounter{table}{-1}
\renewcommand\tablename{Table}
\caption{No CRC check instruction frame format}
\label{table51}
\small
%\setlength\tabcolsep{2.8pt}
\renewcommand{\arraystretch}{1.5}
\centering
\begin{tabular}{cccccccccccccccccccc}
\\
\bottomrule
%           \cline{2-4}\cline{6-8}
~~~指令~~~  &&&& EE   &&&&     XX    &&&&~~XX~XX~$\cdot\cdot\cdot$~XXX~~&&&& ~~FF~FC~FF~FF~~ \\
\hline
说明  &&&& ~~~帧头~~~ &&&&    ~~~指令~~~   &&&& ~~指令参数~~     &&&& 帧尾   \\
\bottomrule
\end{tabular}
\end{table*}

为了使~DSP~控制能够很好的接收或发送指令来控制触摸屏显示，本课题设计如图~\ref{fig72}~所示的程序驱动架构，其中最下层为用户处理串口的硬件驱动，往上一层为串口屏的命令帧驱动，再上面一层是串口消息响应处理函数，最上面为用户应用代码。
\begin{figure*}[!h]
\centering
\includegraphics[width=8cm]{fig72.pdf}
\caption {DSP~程序驱动框架}
\addtocounter{figure}{-1}
\renewcommand\figurename{Fig.}
\caption{\label{fig72} DSP~ Driver Framework}
\end{figure*}

基于以上程序框图，本课题的~DSP~与通信程序流程图如图~\ref{fig71}~所示。
\begin{figure*}[!h]
\centering
\includegraphics[width=10cm]{fig71.pdf}
\caption {触摸屏串口通信程序流程图}
\addtocounter{figure}{-1}
\renewcommand\figurename{Fig.}
\caption{\label{fig71}  Program flow chart of touch screen serial communication}
\end{figure*}

\subsection{温度控制程序的设计}

\section{数字锁相放大器软件设计}
数字锁相放大器的核心算法为相关运算，即有两路信号，一路为标准的正弦参考信号，一路为同频带噪声信号，目的是滤除噪声，故用这两路信号进行相关运算，根据信号与信号之间有相关性，与噪声之间无相关性从而滤除噪声。并且为了排除相位差带来的误差和精度的损失，还应产生一路正交参考信号与待测信号做相关。


\subsection{参考信号的产生}
产生正弦信号的方法归纳起来主要有两种：一种是使用正弦函数直接产生，从而给出精确到每个角度的正弦波形值；另一种是使用查表法来生成，即首先建立一个包含有正弦波数据的表，然后根据所需正弦信号的频率和相位在正弦表中找到对应的正弦值。两种方式都有各自的优缺点，使用时可以根据具体需要来进行选择。第一种方法占用的存储空间小，精度可以通过算法进行调整，但计算量大，耗时。通常用于精
度要求高，实时性要求低的场合；第二种方法实时性好，可以快速产生所需正弦信号，但在精度要求高的情况下就需要使用很大的表来存储标准正弦信号，进而需要大量的存储空间来存储该表，故通常适用于实时性要求高，精度要求相对低的场合\upcite{sin}。

本次设计选用了查表法来产生正弦信号，由于三角函数的对称性，只要存储三角函数四分之一周期的函数值，就能获得整个周期三角函数的信息。因此，使用~MATLAB~来产生三角函数值，并用十六进制表示，将采样后的三角函数值的前四分之一周期采样值存入表中，形成工程中的~sintab.c~文件供查表使用。下图为查表产生正弦信号的流程图。

\subsection{相关运算的实现}
本节重点介绍数字锁相放大器的核心算法相关运算的~C~语言实现，带噪声的正弦信号与同频正弦参考信号做同相相关，与同频正交参考信号做正交相关。即根据式(2一43)及(2一44)编写程序来实现相关运算。

相关运算算法的流程图如下。

\subsection{数字滤波器的设计}

\section{工业串口屏软件设计}\label{end_TFT}

本系统的人机交互采用组态串口触摸屏进行显示和按键等操作。当前工控领域TFT显示已成为发展趋势，传统的~1602、12864~以及数码管已经无法满足产品需求和用户体验。广州大彩光电科技有限公司推出的工业串口屏是集~TFT~显示驱动、图片字库存储、GUI~操作、RTC~显示及各种组态控件于一体的串口显示终端。用户单片机只需要发送相应的串口指令就可以轻松实现文本、图片和曲线显示。本课题采用了该公司生产的一款基本型工业串口屏――~DC80480B070。

DC80480B070~能适应恶劣环境、强磁干扰和户外等工作场合。系统处理器采用~Cortex-M3+~高速~FPGA~双核设计，ARM~主要进行协议解析和 USB~图片下载，FPGA~ 主要实现~Nandflash~的图片读取和~TFT~控制显示。内部结构如图~\ref{fig70}~所示。
\begin{figure*}[!h]
\centering
\includegraphics[width=12cm]{fig70.png}
\caption {TFT~串口屏内部结构图}
\addtocounter{figure}{-1}
\renewcommand\figurename{Fig.}
\caption{\label{fig70} TFT serial screen internal structure}
\end{figure*}

DSP~需要一个串口就能实现文本、GUI、图片、gif~动画显示和触摸控制等功能，支持多种常用组态控件：触摸控件、文本控件、进度条、滑动条和仪表控件等。设备内部有~4.7K~字节的指令缓存区，用户主机可无等待、连续发送多条指令后退出串口程序。整个过程操作简单，程序代码量大大降低。

操作时，用户首先利用配套的上位机~VisualTFT~软件，将预先设计好的美工图片进行界面排版和控件配置，然后使用内置的“虚拟串口屏”进行模拟仿真，最后通过~UART~或~SD~卡方式将整个工程图片和配置信息下载到串口屏内部存储器中。下载之前，上位机将会对工程中的每个画面、图片和控件分配一个唯一的~ID。一旦触摸被按下，用户单片机串口就会收到屏幕上传的按钮~ID~值，通过解析~ID~值就可以判断当前哪个按钮被按下，然后发送相应的指令去控制画面的显示。

串口屏使用~VisualTFT~软件进行组态界面的设计，VisualTFT~串口屏配套的界面开发调试软件。用户新建工程后，导入设计好的美工图片，然后对每个画面中的按钮和其它控件进行配置，每一个页面和空间分配唯一的~ID。模拟仿真正确后，最后将整个工程下载到串口屏中。设备与~PC~连接成功后，可进行同步和调试显示。

本课题设计的界面分为六个界面，主界面如图5.6所示，用于显示实时水分值、探测器温度值和电机转速值。其余几个界面分别用于显示水分曲线、温度曲线和电机转速曲线、各通道的采样电压值以及设置参数。


\section{本章小结}
本章详细介绍了数据的采样与数字滤波处理。基于~STM32~单片机重新编写了软件程序，给出了各部分的程序流程图。对探测器的温度进行了控制，得出了温度控制曲线。简单介绍了工业组态串口屏，编写了组态界面以及程序，实现了文本显示、参数设置等人机交互。















